"0","# function to convert iterative observation intervals of co2 accumulation over 4min time periods (in concentration, ppm) to units of co2 mass accumulation; the function uses ideal gas laws and a humidity correction to convert from ppm to kg co2. Once converted, the function then takes both a linear and quadratic regression of each accumulation interval, and uses the resultant slopes (beta values) to calculate a rate of increase in CO2 over time, per unit area."
"0",""
"0","# currently the function requires an input of the time series dataframe itself, a custom intervals dataframe (two columns, one labeled ""Start"" and one labeled ""End"" with each row indicating the ideal start and end of each interval in the time series df in POSIXct format), and an indication of the method (e.g. is it ""LGR"" or ""fluxbot"" generated data)."
"0",""
"0","calculate_regressions_custom_intervals <- function(time_series_df, custom_intervals_df, method) {"
"0","  # Extract timestamp and data columns from the time series dataframe"
"0","  timestamp_col <- as.POSIXct(time_series_df$Time, format = ""%Y-%m-%d %H:%M:%S"", tz = ""America/New_York"")"
"0","  data_col <- time_series_df$co2     "
"0",""
"0","  # Initialize an empty dataframe to store the results"
"0","  results_df <- data.frame("
"0","    start_timestamp = character(),"
"0","    end_timestamp = character(),"
"0","    linear_beta = numeric(),"
"0","    quadratic_beta = numeric()"
"0","  )"
"0","  "
"0","  # Quality control thresholds: if an interval 'fails' any of these it is skipped and excluded from the final output"
"0","    diff_threshold <- 5 # difference in co2 concentration delta from start-end needs to be greater than 5ppm"
"0","    max_threshold <- 3000 # eliminate any intervals that contain co2 concentrations greater than 3k ppm"
"0","    length_threshold <- 15 # the length of an interval needs to be at least 15 observations (40 obs per 4mins interval for fluxbot)"
"0","    "
"0","  # constants for conversion of concentration to mass:"
"0","    R_m = 8.314472  # Ideal gas constant for mass [(m3*Pa)/(K*mol)]"
"0","    R_specific <- 287.058 # specific gas constant for dry air (J/kg*K)"
"0","    mol_mass <- 28.9628 # molar mass dry air, g/mol"
"0","    volume <- 768 # cm3; volume of fluxbot chamber"
"0","    area <- 81 # cm2; area of soil that fluxbot collar encompasses"
"0","    g_per_mol = 44.009 # molar mass of CO2, g/mol"
"0",""
"0","  # Loop through each row in the custom intervals dataframe to ID the start and end point of each interval"
"0","  for (i in seq_len(nrow(custom_intervals_df))) {"
"0","    # Extract start and end points for the current row"
"0","    start_point <- custom_intervals_df$Start[i]"
"0","    end_point <- custom_intervals_df$End[i]"
"0",""
"0","    # Find the closest timestamp to start_point and end_point in the time series data itself:"
"0","    start_index <- which.min(abs(timestamp_col - start_point))"
"0","    end_index <- which.min(abs(timestamp_col - end_point))"
"0",""
"0","    # Extract the CO2 concentration data for each interval iteratively using the above timestamps:"
"0","    interval_data <- time_series_df$co2[start_index:end_index]"
"0","    interval_timestamp <- time_series_df$Time[start_index:end_index]"
"0","    # determine total length of interval; reports in mins, so convert to sec:"
"0","    length_interval <- (as.numeric(time_series_df$Time[end_index] - time_series_df$Time[start_index]))*60"
"0","    "
"0","    # Quality control checks with printouts of reasons for excluding a given interval:"
"0","    if (any(is.na(interval_data))) {"
"0","      cat(""Skipping interval due to NAs in the data:"", i, ""\n"")"
"0","      next  # Skip to the next iteration"
"0","    }"
"0",""
"0","    # Quality control checks:"
"0","    if (abs(interval_data[1] - interval_data[length(interval_data)]) < diff_threshold) {"
"0","      cat(""Skipping interval due to extremely small delta:"", i, ""\n"")"
"0","      next  # Skip to the next iteration"
"0","    }"
"0","    if(max(interval_data) > max_threshold) {"
"0","      cat(""Skipping interval: concentration too high:"", i, ""\n"")"
"0","      next # Skip to the next iteration"
"0","    }"
"0","    if(length(interval_data) < length_threshold) {"
"0","      cat(""Skipping interval due to insufficient length:"", i, ""\n"")"
"0","      next # Skip to the next iteration"
"0","    }"
"0","    "
"0","    # calculate rho_a, air density in kg/m3, including humidity:"
"0","    # first step, calculate saturation vapor pressure in hPa"
"0","    e_star <- 10*(0.61978 * exp((17.27 * time_series_df$tempC)[start_index:end_index]/"
"0","                                  (time_series_df$tempC[start_index:end_index] + "
"0","                                     273.3))) # saturation vapor pressure, hPa"
"0","    # next: saturation density (kg water / kg air) given saturation vapor pressure (e_star) and observed air pressure"
"0","      # 0.62198 = ratio of molecular masses of water and dry air (18.01528 / 28.9645)"
"0","    x_s <- 0.62198 * e_star / (time_series_df$pressure[start_index:end_index] - e_star) "
"0","    "
"0","    # next: calculate humidity ratio using saturation density and observed relative humidity:"
"0","    x <- x_s * time_series_df$humidity[start_index:end_index] / 100 # divide by 100 to convert to a fraction"
"0","    "
"0","    # finally, calculate the observed density of humidity-corrected air in the chamber:"
"0","    # first: density of air in kg/m3 using specific gas constant for dry air"
"0","    rho_d <- (time_series_df$pressure[start_index:end_index] * 100) / "
"0","      (R_specific * (time_series_df$tempC[start_index:end_index] + 273.15)) # here converting T to Kelvin from Celcius"
"0","    # air density in kg/m3 with humidity correction as calculated in ""x"" above:"
"0","      # 1.609 = gas constant ratio between water vapor and air"
"0","    rho_a <- rho_d * (1+x) / (1 + 1.609 * x) "
"0","    "
"0","    # convert (general) co2 in ppm to mol/m3"
"0","    mol_kg = 1/(mol_mass/1000) # mass of air in mol/kg"
"0","    # calculate mol of moist air per m3 in the chamber given previously-calculated moist air densities"
"0","    mol_m3 = mol_kg * rho_a # mass of moist air in chamber in mol/m3"
"0","    "
"0","    # convert (our observed) co2 in ppm to molar density using chamber volume:"
"0","    mol_gas_m3 <- mol_m3 * (interval_data/1000000) # returns mol/m3 (conversion from cm3 to m3 = 1,000,000)"
"0","  "
"0","    # convert molar concentration of CO2 into concentration in kg/m3"
"0","    kg_gas_m3 <- mol_gas_m3 * (g_per_mol/1000) # (conversion of g to kg = 1000)"
"0","      "
"0","    # convert to just mass in kg (volume reported in cm3, converting to m3 here, inverse conversion = 0.000001):"
"0","    kg_gas <- kg_gas_m3 * (volume * 0.000001) # returns kg of co2 in the chamber at each time point in interval"
"0",""
"0","    # Linear regression"
"0","    linear_model <- lm(kg_gas ~ as.numeric(difftime(interval_timestamp, min(interval_timestamp), units = ""secs"")))"
"0","    linear_results <- summary(linear_model)"
"0","    linear_beta <- coef(linear_results)[2]  # Extract the beta coefficient; kg/s"
"0","    delta_kg_L = linear_beta*(length_interval) # units in kg"
"0","    delta_g_L = delta_kg_L*1000 # units in g"
"0","    delta_mol_L = delta_g_L / g_per_mol # units in mols"
"0","    fluxL = delta_kg_L / length_interval / (area*0.0001) # flux estimate in kg/m2/sec"
"0","    fluxL_umol = (delta_mol_L*1000000) / length_interval / (area * 0.0001) # flux estimate in umol/m2/sec"
"0",""
"0","    # Quadratic regression"
"0","    quadratic_model <- lm(kg_gas ~ "
"0","                            as.numeric(difftime(interval_timestamp, min(interval_timestamp), "
"0","                                                units = ""secs"")) +"
"0","                            I(as.numeric(difftime(interval_timestamp, "
"0","                                                  min(interval_timestamp), "
"0","                                                  units = ""secs""))^2))"
"0","    quadratic_results <- summary(quadratic_model)"
"0","    quadratic_beta <- coef(quadratic_results)[2]  # Extract the beta coefficient; kg/s"
"0","    delta_kg_Q  = quadratic_beta*(length_interval) # units in kg"
"0","    delta_g_Q = delta_kg_Q*1000 # units in g"
"0","    delta_mol_Q = delta_g_Q / g_per_mol # units in mols"
"0","    fluxQ = delta_kg_Q / length_interval / (area*0.0001) # flux estimate in kg/m2/sec"
"0","    fluxQ_umol = (delta_mol_Q*1000000) / length_interval / (area * 0.0001) # flux estimate in umol/m2/sec"
"0",""
"0","    # Append the results to the dataframe"
"0","    results_df <- rbind(results_df, data.frame("
"0","      start_timestamp = start_point,"
"0","      end_timestamp = end_point,"
"0","      hour_of_obs = round(end_point, ""hour""),"
"0","      method = method,"
"0","      linear_beta = linear_beta, # kg/s"
"0","      quadratic_beta = quadratic_beta, # kg/s"
"0","      length_interval = length_interval, # total interval length in seconds"
"0","      delta_kg_L = linear_beta/length_interval, # units in kg"
"0","      delta_kg_Q  = quadratic_beta/length_interval, # units in kg"
"0","      fluxL_kgm2sec = fluxL, # flux estimate in kg/m2/sec"
"0","      fluxQ_kgm2sec = fluxQ, # flux estimate in kg/m2/sec"
"0","      fluxL_umolm2sec = fluxL_umol, # flux estimate in umol/m2/sec"
"0","      fluxQ_umolm2sec = fluxQ_umol  # flux estimate in umol/m2/sec"
"0","    ))"
"0","  }"
"0",""
"0","  # Return the results"
"0","  return(results_df)"
"0","}"
"0",""
